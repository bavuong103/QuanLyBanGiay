function Boxy(t,e){this.boxy=jQuery(Boxy.WRAPPER),jQuery.data(this.boxy[0],"boxy",this),this.visible=!1,this.options=jQuery.extend({},Boxy.DEFAULTS,e||{}),this.options.modal&&(this.options=jQuery.extend(this.options,{center:!0,draggable:!1})),this.options.actuator&&jQuery.data(this.options.actuator,"active.boxy",this),this.setContent(t||"<div></div>"),this._setupTitleBar(),this.boxy.css("display","none").appendTo(document.body),this.toTop(),this.options.fixed&&(jQuery.browser.msie&&jQuery.browser.version<7?this.options.fixed=!1:this.boxy.addClass("fixed")),this.options.center&&Boxy._u(this.options.x,this.options.y)?this.center():this.moveTo(Boxy._u(this.options.x)?this.options.x:Boxy.DEFAULT_X,Boxy._u(this.options.y)?this.options.y:Boxy.DEFAULT_Y),this.options.show&&this.show()}jQuery.fn.boxy=function(t){return t=t||{},this.each(function(){var e=this.nodeName.toLowerCase(),i=this;"a"==e?jQuery(this).click(function(){var e=Boxy.linkedTo(this),i=this.getAttribute("href"),o=jQuery.extend({actuator:this,title:this.title},t);if(e)e.show();else if(i.indexOf("#")>=0){var n=jQuery(i.substr(i.indexOf("#"))),s=n.clone(!0);n.remove(),o.unloadOnHide=!1,new Boxy(s,o)}else o.cache||(o.unloadOnHide=!0),Boxy.load(this.href,o);return!1}):"form"==e&&jQuery(this).bind("submit.boxy",function(){return Boxy.confirm(t.message||"Please confirm:",function(){jQuery(i).unbind("submit.boxy").submit()}),!1})})},Boxy.EF=function(){},jQuery.extend(Boxy,{WRAPPER:"<table cellspacing='0' cellpadding='0' border='0' class='boxy-wrapper'><tr><td class='top-left'></td><td class='top'></td><td class='top-right'></td></tr><tr><td class='left'></td><td class='boxy-inner'></td><td class='right'></td></tr><tr><td class='bottom-left'></td><td class='bottom'></td><td class='bottom-right'></td></tr></table>",DEFAULTS:{title:null,closeable:!0,draggable:!0,clone:!1,actuator:null,center:!0,show:!0,modal:!1,fixed:!0,closeText:"[close]",unloadOnHide:!1,clickToFront:!1,behaviours:Boxy.EF,afterDrop:Boxy.EF,afterShow:Boxy.EF,afterHide:Boxy.EF,beforeUnload:Boxy.EF},DEFAULT_X:50,DEFAULT_Y:50,zIndex:1337,dragConfigured:!1,resizeConfigured:!1,dragging:null,load:function(t,e){e=e||{};var i={url:t,type:"GET",dataType:"html",cache:!1,success:function(t){t=jQuery(t),e.filter&&(t=jQuery(e.filter,t)),new Boxy(t,e)}};jQuery.each(["type","cache"],function(){this in e&&(i[this]=e[this],delete e[this])}),jQuery.ajax(i)},get:function(t){var e=jQuery(t).parents(".boxy-wrapper");return e.length?jQuery.data(e[0],"boxy"):null},linkedTo:function(t){return jQuery.data(t,"active.boxy")},alert:function(t,e,i){return Boxy.ask(t,["OK"],e,i)},confirm:function(t,e,i){return Boxy.ask(t,["OK","Cancel"],function(t){"OK"==t&&e()},i)},ask:function(t,e,i,o){o=jQuery.extend({modal:!0,closeable:!1},o||{},{show:!0,unloadOnHide:!0});var n=jQuery("<div></div>").append(jQuery('<div class="question"></div>').html(t)),s={},r=[];if(e instanceof Array)for(var u=0;u<e.length;u++)s[e[u]]=e[u],r.push(e[u]);else for(var h in e)s[e[h]]=h,r.push(e[h]);var a=jQuery('<form class="answers"></form>');a.html(jQuery.map(r,function(t){return"<input type='button' value='"+t+"' />"}).join(" ")),jQuery("input[type=button]",a).click(function(){var t=this;Boxy.get(this).hide(function(){i&&i(s[t.value])})}),n.append(a),new Boxy(n,o)},isModalVisible:function(){return jQuery(".boxy-modal-blackout").length>0},_u:function(){for(var t=0;t<arguments.length;t++)if("undefined"!=typeof arguments[t])return!1;return!0},_handleResize:function(t){var e=jQuery(document);jQuery(".boxy-modal-blackout").css("display","none").css({width:e.width(),height:e.height()}).css("display","block")},_handleDrag:function(t){var e;(e=Boxy.dragging)&&e[0].boxy.css({left:t.pageX-e[1],top:t.pageY-e[2]})},_nextZ:function(){return Boxy.zIndex++},_viewport:function(){var t=document.documentElement,e=document.body,i=window;return jQuery.extend(jQuery.browser.msie?{left:e.scrollLeft||t.scrollLeft,top:e.scrollTop||t.scrollTop}:{left:i.pageXOffset,top:i.pageYOffset},Boxy._u(i.innerWidth)?Boxy._u(t)||Boxy._u(t.clientWidth)||0==t.clientWidth?{width:e.clientWidth,height:e.clientHeight}:{width:t.clientWidth,height:t.clientHeight}:{width:i.innerWidth,height:i.innerHeight})}}),Boxy.prototype={estimateSize:function(){this.boxy.css({visibility:"hidden",display:"block"});var t=this.getSize();return this.boxy.css("display","none").css("visibility","visible"),t},getSize:function(){return[this.boxy.width(),this.boxy.height()]},getContentSize:function(){var t=this.getContent();return[t.width(),t.height()]},getPosition:function(){var t=this.boxy[0];return[t.offsetLeft,t.offsetTop]},getCenter:function(){var t=this.getPosition(),e=this.getSize();return[Math.floor(t[0]+e[0]/2),Math.floor(t[1]+e[1]/2)]},getInner:function(){return jQuery(".boxy-inner",this.boxy)},getContent:function(){return jQuery(".boxy-content",this.boxy)},setContent:function(t){return t=jQuery(t).css({display:"block"}).addClass("boxy-content"),this.options.clone&&(t=t.clone(!0)),this.getContent().remove(),this.getInner().append(t),this._setupDefaultBehaviours(t),this.options.behaviours.call(this,t),this},moveTo:function(t,e){return this.moveToX(t).moveToY(e),this},moveToX:function(t){return"number"==typeof t?this.boxy.css({left:t}):this.centerX(),this},moveToY:function(t){return"number"==typeof t?this.boxy.css({top:t}):this.centerY(),this},centerAt:function(t,e){var i=this[this.visible?"getSize":"estimateSize"]();return"number"==typeof t&&this.moveToX(t-i[0]/2),"number"==typeof e&&this.moveToY(e-i[1]/2),this},centerAtX:function(t){return this.centerAt(t,null)},centerAtY:function(t){return this.centerAt(null,t)},center:function(t){var e=Boxy._viewport(),i=this.options.fixed?[0,0]:[e.left,e.top];return t&&"x"!=t||this.centerAt(i[0]+e.width/2,null),t&&"y"!=t||this.centerAt(null,i[1]+e.height/2),this},centerX:function(){return this.center("x")},centerY:function(){return this.center("y")},resize:function(t,e,i){if(this.visible){var o=this._getBoundsForResize(t,e);return this.boxy.css({left:o[0],top:o[1]}),this.getContent().css({width:o[2],height:o[3]}),i&&i(this),this}},tween:function(t,e,i){if(this.visible){var o=this._getBoundsForResize(t,e),n=this;return this.boxy.stop().animate({left:o[0],top:o[1]}),this.getContent().stop().animate({width:o[2],height:o[3]},function(){i&&i(n)}),this}},isVisible:function(){return this.visible},show:function(){if(!this.visible){if(this.options.modal){var t=this;Boxy.resizeConfigured||(Boxy.resizeConfigured=!0,jQuery(window).resize(function(){Boxy._handleResize()})),this.modalBlackout=jQuery('<div class="boxy-modal-blackout"></div>').css({zIndex:Boxy._nextZ(),opacity:.7,width:jQuery(document).width(),height:jQuery(document).height()}).appendTo(document.body),this.toTop(),this.options.closeable&&jQuery(document.body).bind("keypress.boxy",function(e){var i=e.which||e.keyCode;27==i&&(t.hide(),jQuery(document.body).unbind("keypress.boxy"))})}return this.boxy.stop().css({opacity:1}).show(),this.visible=!0,this._fire("afterShow"),this}},hide:function(t){if(this.visible){var e=this;return this.options.modal&&(jQuery(document.body).unbind("keypress.boxy"),this.modalBlackout.animate({opacity:0},function(){jQuery(this).remove()})),this.boxy.stop().animate({opacity:0},300,function(){e.boxy.css({display:"none"}),e.visible=!1,e._fire("afterHide"),t&&t(e),e.options.unloadOnHide&&e.unload()}),this}},toggle:function(){return this[this.visible?"hide":"show"](),this},hideAndUnload:function(t){return this.options.unloadOnHide=!0,this.hide(t),this},unload:function(){this._fire("beforeUnload"),this.boxy.remove(),this.options.actuator&&jQuery.data(this.options.actuator,"active.boxy",!1)},toTop:function(){return this.boxy.css({zIndex:Boxy._nextZ()}),this},getTitle:function(){return jQuery("> .title-bar h2",this.getInner()).html()},setTitle:function(t){return jQuery("> .title-bar h2",this.getInner()).html(t),this},_getBoundsForResize:function(t,e){var i=this.getContentSize(),o=[t-i[0],e-i[1]],n=this.getPosition();return[Math.max(n[0]-o[0]/2,0),Math.max(n[1]-o[1]/2,0),t,e]},_setupTitleBar:function(){if(this.options.title){var t=this,e=jQuery("<div class='title-bar'></div>").html("<h2>"+this.options.title+"</h2>");this.options.closeable&&e.append(jQuery("<a href='#' class='close'></a>").html(this.options.closeText)),this.options.draggable&&(e[0].onselectstart=function(){return!1},e[0].unselectable="on",e[0].style.MozUserSelect="none",Boxy.dragConfigured||(jQuery(document).mousemove(Boxy._handleDrag),Boxy.dragConfigured=!0),e.mousedown(function(e){t.toTop(),Boxy.dragging=[t,e.pageX-t.boxy[0].offsetLeft,e.pageY-t.boxy[0].offsetTop],jQuery(this).addClass("dragging")}).mouseup(function(){jQuery(this).removeClass("dragging"),Boxy.dragging=null,t._fire("afterDrop")})),this.getInner().prepend(e),this._setupDefaultBehaviours(e)}},_setupDefaultBehaviours:function(t){var e=this;this.options.clickToFront&&t.click(function(){e.toTop()}),jQuery(".close",t).click(function(){return e.hide(),!1}).mousedown(function(t){t.stopPropagation()})},_fire:function(t){this.options[t].call(this)}};